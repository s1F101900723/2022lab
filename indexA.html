<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Web Serial API Console</title>
    <script>
      //Global Variables
      var exports = {};
    </script>  
    <script>
        let port;


        async function onConnectButtonClick() {
          if (navigator.serial) {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });

                while (port.readable) {
                    const reader = port.readable.getReader();

                    try {
                        while (true) {
                            const { value, done } = await reader.read();
                            if (done) {
                                addSerialError("Canceled\n");
                                break;
                            }
                            const inputValue = new TextDecoder().decode(value);
                            addSerial(inputValue);
                        }
                    } catch (error) {
                        addSerialError("Error: Read" + error + "\n");
                    } finally {
                        reader.releaseLock();
                    }
                }
            } catch (error) {
                addSerialError("Error: Open" + error + "\n");
            }
          } else {
            console.log('Web Serial API not supported. Switching to Polyfill<br>');
            myPoly();
          }
        }

        function addSerial(msg) {
            var textarea = document.getElementById('outputArea');
            textarea.value += msg;
            textarea.scrollTop = textarea.scrollHeight;
            var list = textarea.value.split(/\r\n|\n/);//.map(Number)
            var list1= textarea.value.split(/\r\n|\n/).slice(0,-1);
            var match = /\r|\n/.exec(msg);
            if (match) {
              //console.log("ある",msg);
              createchart1(list1);
              //console.log(list1);
            }
            //console.log(list);
        }

        function addSerialError(msg) {
            var errortextarea = document.getElementById('erroroutputArea');
            errortextarea.value += msg;
            errortextarea.scrollTop = errortextarea.scrollHeight;
        }

        async function sendSerial(changes, melo) {
          if (navigator.serial) {
            const encoder = new TextEncoder();
            const writer = port.writable.getWriter();
            await writer.write(encoder.encode(changes + melo + "\n"));
            writer.releaseLock();
          } else {
            console.log('send Web Serial API not supported. Switching to Polyfill<br>');
            //myPoly();
          }
        }



// start polyfill for Android




  //Global Variables for Polyfill
  var serial = exports.serial;  // is this needed as defined in the npm
 
  let myLooping  // for read setinterval
  var mySerial;
  //let receivedText = '';
  let reader = {};
  let writer = {};
  
   str2ab = function(str) {
    var buf = new Uint8Array(str.length); // 1 byte for each char
    for (var i=0, strLen=str.length; i < strLen; i++) {
      buf[i] = str.charCodeAt(i);
    }
    return buf;
  }

  ab2str = function(buf) {
    return String.fromCharCode.apply(null, buf);
  } 
  
  async function myPoly(){  
    mySerial = await serial.requestPort();
                                                                     
    //document.getElementById('myDiv01').innerHTML += await '<b>mySerial: </b><br><pre>' +  JSON.stringify(mySerial, null, 3) + '</pre><br><br>'      
                                            
                                                                                     
    console.log('mySerial');
    console.log(mySerial);

    const myOpen = await mySerial.open({baudRate: 115200});
    reader = mySerial.readable.getReader();                                              
    writer = mySerial.writable.getWriter();    
                                            
    const results = mySerial.getInfo();
    
    //document.getElementById('myDiv01').innerHTML += await 'Results:<b>: </b><br><pre>' +  JSON.stringify(results, null, 3) + '</pre><br><br>'                                          
    console.log('get info results', results);
    //document.getElementById('myDiv01').innerHTML += 'results.usbVendorId: ' + results.usbVendorId + '<br>'
    //document.getElementById('myDiv01').innerHTML += 'results.usbProductId: ' + results.usbProductId + '<br>'
 
    
    // start looping the serial read. Is there a better way to do this?
    clearInterval(myLooping);
    myLooping = setInterval(myRead, 1000); 
  }
  
  async function myRead(){  
      reader.read().then(({value}) => {        
          let receivedText = ab2str(value);
          //document.getElementById('target').innerHTML = receivedText + '<br>' + document.getElementById('target').innerHTML // latest on top
        },
        error => {
        console.error('error from read', error);
      //document.getElementById('myDiv01').innerHTML = 'error from read' + error
      }
      );
  }
  

        
  async function mySend(myData2){  
      writer.ready.then(() => {                                         
        let inputArrayBuffer = str2ab(myData2);
        const myWritten = writer.write(inputArrayBuffer);
        console.log('myWritten');
        console.log(myWritten);
                                          
        //document.getElementById('myDiv01').innerHTML = '<br><br><b>myWriter: </b><br><pre>' +  JSON.stringify(myWritten, null, 3) + '</pre><br><br>'  
                                              
    
      })    
  } 
















    </script>
</head>

<body>
    <h1>Web Serial API Console</h1>
    <button onclick="onConnectButtonClick()">Connect</button> 115200 Only
    <br />

    <input type="number" value="300" id="rangevalue" min="200" max="1000">ms
    <br/>
    <input type="range" id="rangespeed" min="200" max="1000" value="300">
    <br/>



            <div class="button r" id="button-1">
              <input type="checkbox" class="checkbox" id="modecheckbox"/>
              <div class="knobs"></div>
              <div class="k2"></div>
              <div class="layer"></div>
            </div>
            <br>
            <br>
            <div class="button r" id="button-2">
              <input type="checkbox" class="checkbox" id="powercheckbox"/>
              <div class="knobs"></div>
              <div class="k2"></div>
              <div class="layer"></div>
            </div>



    <!--input type="text" id="sendInput" />
    <input type="button" value="Send" onclick="sendSerial();" /-->
    <br />
    <p>取得データ</p><button onclick="createchart1(document.getElementById('outputArea').value.split(/\r\n|\n/).map(Number))">更新</button>
    <textarea cols="80" rows="6" id="outputArea"></textarea>
    <p>接続状況</p>
    <textarea cols="80" rows="6" id="erroroutputArea" readonly></textarea>
    <p>折れ線グラフ</p>
    <canvas id="myLineChart"></canvas>
    <canvas id="myLineChart2"></canvas>
    <!--script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script-->
    <!--script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/Chart.min.js"></script-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link rel="stylesheet" href="sample.css">
  </body>

<script>
  var elem = document.getElementById('rangespeed');
  var target = document.getElementById('rangevalue');
  var rangeValue = function (elem, target, changes) {
    return function(evt){
      target.value = elem.value;
      sendSerial(changes,target.value);//音の長さ変更
    }
  }
  elem.addEventListener('input', rangeValue(elem, target, 'L'));
  target.addEventListener('input', rangeValue(target, elem, 'L'));


  function modevalueChange(event){
    if (ModeCheckbox.checked){
      //console.log("全身");
      sendSerial('M','body');
    }else{
      //console.log("手");
      sendSerial('M','hand');
    }
  }
  let ModeCheckbox = document.getElementById('modecheckbox');
  ModeCheckbox.addEventListener('change', modevalueChange);

  function powervalueChange(event){
    if (PowerCheckbox.checked){
      //console.log("全身");
      sendSerial('S','ON');
    }else{
      //console.log("手");
      sendSerial('S','OFF');
    }
  }

let PowerCheckbox = document.getElementById('powercheckbox');
PowerCheckbox.addEventListener('change', powervalueChange);


</script>

<script>
  window.onload = function() {
    var ctx = document.getElementById("myLineChart");
    window.myLineChart = new Chart(ctx, {

      data: {
          datasets: [{
              indexAxis: 'x',
              label: 'ガイド',
              data: [,277.183,277.183,391.995,391.995],
              type: 'line',
              // this dataset is drawn on top
              stepped: true,//←サンプリング
              pointRadius:0,
              borderColor: 'rgb(0, 192, 192)',
              borderWidth:1,
              fill: true,
          },
          {
              label: 'ガイド',
              data: [,277.183,277.183,391.995,391.995,300],
              type: 'bar',
              // this dataset is drawn on top
              indexAxis: 'y',
              pointRadius:0,
              borderColor: 'rgb(0, 192, 192)',
              borderWidth:1,
              fill: true,
              yAxisID: 'y2',
              xAxisID: 'x2',


          },
          {
              indexAxis: 'x',
              label: 'Line Dataset',
              data: [],
              type: 'line',
              // this dataset is drawn on top
              stepped: true,//←サンプリング
              pointRadius:0,
              borderColor: 'rgb(75, 192, 192)',
              borderWidth:1,
              fill: true,
          },
          {
              label: 'Line Dataset2',
              data: [],
              type: 'bar',
              // this dataset is drawn on top
              indexAxis: 'y',
              pointRadius:0,
              borderColor: 'rgb(192, 192, 192)',
              borderWidth:1,
              fill: true,
              yAxisID: 'y2',
              xAxisID: 'x2',

          }],
          labels: [],
          tension: 1
      },
      options: {
      responsive: true,
      scales: {
        x: {

          ticks: {
            maxTicksLimit: 6,
          }
        },
        y: {

          stack: 'demo',
          min: 0,
          max: 1100,
          beginAtZero: true,
          stackWeight: 12,
          ticks: {
            maxTicksLimit: 12
          }
        },
        x2: {
          position: 'top',
          min: 0,
          max: 1100,
          ticks: {
            maxTicksLimit: 12,
          }
        },
        y2: {
          //display:false,
          stacked: true,
          stack: 'demo',
          stackWeight: 8,
          //offset:true,
          ticks: {
            
          }
        },
   
      },
      animation: false,
      
    }
    });
  };

  function createchart1(list){
    //list=[,].concat([100.01,120,40,50,100,120,300,40,30,100,120,40,50,100,120,300,40,30,120,300,40,30,120,300,40,30]);
    list=([,].concat(list)).concat([,])
    var listtime=[...Array(list.length).keys()].map(i => (i)*elem.value/1000);
    console.log(listtime.length);
    console.log(listtime.length-1);
    window.myLineChart.data.datasets[2].data = list;
    window.myLineChart.data.datasets[3].data = list;
    window.myLineChart.options.scales.x.max = listtime[listtime.length-1];
    window.myLineChart.options.scales.x.min = listtime[listtime.length-10];
    window.myLineChart.options.scales.y2.max = listtime[listtime.length-1];
    window.myLineChart.options.scales.y2.min = listtime[listtime.length-2];
    window.myLineChart.data.labels = listtime;
    window.myLineChart.update();
  }
</script>

</html>